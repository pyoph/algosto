#######################################################
################Directories############################
#######################################################
################à adapter en fonction de votre configuration
##########################################################
simDir <- "~/work/Simus/DataSim"
resDir <- "~/work/Simus/FitSim"
explDir = "~/work/Simus/exploitResults"


d <- 10
rList <- 5*(0:10)
load(paste0('SimParmsGrid-n', n,'-d', d,'.Rdata'))
simNb <- 1



#Extraction des paramètres
kList = k1val
lList = l1val
rho1List = rho1val

# Plutot simNb que n
erreursSigma = array(0,dim = c(length(rList),length(kList),3))
outliers_labelsRecNaive = rep(0,n)
outliers_labelsRecUsOnline = rep(0,n)
outliers_labelsRecUsStreaming = rep(0,n)
faux_positifsRec = array(0,dim = c(n,length(rList),length(kList),3))
faux_negatifsRec = array(0,dim = c(n,length(rList),length(kList),3))
labels_vraisRec = matrix(0,n,length(rList))

# k = 0 
# 
# l = 1
sim = 1

l = 1
rho1 = rho0

for (i in seq_along(rList) ){
  r = rList[i]
  nb_outliers = r/100*n
  nb_inliers = (1 - r/100)*n
  for (j in seq_along(kList)){
    #rho1 = rho1val[j]
    #print(paste0("rho1 =",rho))
    setwd(simDir)
    k = kList[j]
    dataFile <- paste0('SimData-d', d, '-n', n, '-k', k, '-l', l, '-rho', rho1,'-r',r , '-sim', sim,".RData")
    
    if(!file.exists(dataFile)){
      contParam = ParmsF1(m1, k, l, rho1)
      
      data = genererEchantillon(n,n,mu1 = mu0,mu2 = contParam$mu1,Sigma1 = Sigma0,Sigma2 = contParam$Sigma1,r )
      save(data, file=dataFile)
      print(paste0("n-",n,"d-",d,"k-",k,"l-",l,"r-",r," save ok"))
      
    }
    load(file = dataFile)
    load(dataFile)
    
    labels_vraisRec[,i] = data$labelsVrais
  
    
    setwd(resDir)
    
    fitFile <- paste0('FitParms-d', d,  '-n', n, '-k', k, '-l', l, '-rho', rho1, '-r',r,'-sim', sim,".RData")
    if(!file.exists(fitFile )){
      temps_naif = system.time(
        {fitNaif <- SampleCovOnline(data$Z)})
      print(paste0("Erreur Naif = ",norm(fitNaif$Sigma - Sigma0,"F")))
      temps_online  = system.time({fitUsOnline <- StreamingOutlierDetection(data$Z,batch = 1)})
      print(norm(fitUsOnline$Sigma[n,,] - Sigma0,"F"))
      print(paste0("Erreur online = ",norm(fitUsOnline$Sigma[n,,] - Sigma0,"F")))
      
      temps_streaming = system.time({fitUSStreaming =StreamingOutlierDetection(data$Z,batch = ncol(data$Z))})
      print(norm(fitUSStreaming$Sigma[n,,] - Sigma0,"F"))
      print(paste0("Erreur streaming = ",norm(fitUSStreaming$Sigma[n,,] - Sigma0,"F")))
      
      setwd(resDir)
      save(fitNaif, fitUsOnline, fitUSStreaming,temps_naif,temps_online,temps_streaming,file=fitFile)
    }
    load(fitFile)
    
    erreursSigmaNaive = norm(Sigma0 - fitNaif$Sigma,"F")
    erreursSigma[i,j,1] = erreursSigmaNaive
    
    print(paste0("erreur Sigma naïf ", erreursSigma[i,j,1]))
    erreursSigmaUSOnline = norm(Sigma0 - fitUsOnline$Sigma[n,,],"F")
    erreursSigma[i,j,2] = erreursSigmaUSOnline
    print(paste0("erreur Sigma us online ", erreursSigma[i,j,2]))
    erreursSigmaUSStreaming =  norm(Sigma0 - fitUSStreaming$Sigma[n,,],"F")
    erreursSigma[i,j,3] = erreursSigmaUSStreaming
    print(paste0("erreur Sigma us streaming ", erreursSigma[i,j,3]))
    
    outliers_labelsRecNaive = fitNaif$outliers_labels
    outliers_labelsRecUsOnline = fitUsOnline$outlier_labels
    outliers_labelsRecUsStreaming = fitUSStreaming$outlier_labels
    
    
    if(nb_outliers != 0){
    fn_naive = (sum(outliers_labelsRecNaive == 0 & data$labelsVrais == 1)/(nb_outliers))*100
    faux_negatifsRec[,i,j,1] = fn_naive
    fn_UsOnline = (sum(outliers_labelsRecUsOnline == 0 & data$labelsVrais == 1)/(nb_outliers))*100
    faux_negatifsRec[,i,j,2] = fn_UsOnline
    fn_UsStreaming = sum(outliers_labelsRecUsStreaming == 0 & data$labelsVrais == 1)/(nb_outliers)*100
    faux_negatifsRec[,i,j,3] = fn_UsStreaming
    
    }
    fp_naive = (sum(outliers_labelsRecNaive == 1 & data$labelsVrais == 0)/(nb_inliers))*100
    faux_positifsRec[,i,j,1] = fp_naive
    fp_UsOnline = (sum(outliers_labelsRecUsOnline == 1 & data$labelsVrais == 0)/(nb_inliers))*100
    faux_positifsRec[,i,j,2] = fp_UsOnline
    fp_UsStreaming = (sum(outliers_labelsRecUsStreaming == 1 & data$labelsVrais == 0)/(nb_inliers))*100
    faux_positifsRec[,i,j,3] = fp_UsStreaming
    
    setwd(explDir )
      exploitResFile = paste0('ExploitRes-d', d,  '-n', n, '-k', k, '-l', l, '-rho', rho1, '-r',r,'-sim', sim,".RData")
  if(nb_outliers != 0){      
   save(erreursSigmaNaive,erreursSigmaUSOnline,erreursSigmaUSStreaming, fn_naive,fn_UsOnline,fn_UsStreaming,fp_naive,fp_UsOnline,fp_UsStreaming,file = exploitResFile)
  }
    else {save(erreursSigmaNaive,erreursSigmaUSOnline,erreursSigmaUSStreaming, fp_naive,fp_UsOnline,fp_UsStreaming,file = exploitResFile)}
         
  }
  
}


#Exploit results for l < 1 Other parameters are fixed
k = 0

rho = 0.3

for (i in seq_along(rList) ){
  r = rList[i]
  nb_outliers = r/100*n
  nb_inliers = (1 - r/100)*n
  for (j in seq_along(l1val[1:4])){
    #rho1 = rho1val[j]
    #print(paste0("rho1 =",rho))
    l = l1val[j]
    print(paste0("l = ",l))
    setwd(simDir)
    dataFile <- paste0('SimData-d', d, '-n', n, '-k', k, '-l',l , '-rho', rho,'-r',r , '-sim', sim,".RData")
    
    if(!file.exists(dataFile)){
      m1 <- (-1)^(1:d)/sqrt(d)
      sigmaSq0 <- (1:d); sigmaSq0 <- sigmaSq0 / mean(sigmaSq0)
      SigmaContamin <- diag(sqrt(sigmaSq0)) %*% toeplitz(rho1^(0:(d-1))) %*% diag(sqrt(sigmaSq0))
      
      data = genererEchantillon(n,d,mu1 = mu0, mu2 = k*m1,Sigma1 = Sigma0,Sigma2 = l*SigmaContamin,r)
      save(data, file=dataFile)
      print(paste0("n-",n,"d-",d,"k-",k,"l-",l,"r-",r," save ok"))
      
    }
    load(file = dataFile)
    load(dataFile)
    
    labels_vraisRec[,i] = data$labelsVrais
    
    
    setwd(resDir)
    
    fitFile <- paste0('FitParms-d', d,  '-n', n, '-k', k, '-l', l, '-rho', rho, '-r',r,'-sim', sim,".RData")
    if(!file.exists(fitFile )){
      temps_naif = system.time(
        {fitNaif <- SampleCovOnline(data$Z)})
      print(paste0("Erreur Naif = ",norm(fitNaif$Sigma - Sigma0,"F")))
      temps_online  = system.time({fitUsOnline <- StreamingOutlierDetection(data$Z,batch = 1)})
      print(norm(fitUsOnline$Sigma[n,,] - Sigma0,"F"))
      print(paste0("Erreur online = ",norm(fitUsOnline$Sigma[n,,] - Sigma0,"F")))
      
      temps_streaming = system.time({fitUSStreaming =StreamingOutlierDetection(data$Z,batch = ncol(data$Z))})
      print(norm(fitUSStreaming$Sigma[n,,] - Sigma0,"F"))
      print(paste0("Erreur streaming = ",norm(fitUSStreaming$Sigma[n,,] - Sigma0,"F")))
      
      setwd(resDir)
      save(fitNaif, fitUsOnline, fitUSStreaming,temps_naif,temps_online,temps_streaming,file=fitFile)
    }
    load(fitFile)
    
    erreursSigmaNaive = norm(Sigma0 - fitNaif$Sigma,"F")
    erreursSigma[i,j,1] = erreursSigmaNaive
    
    print(paste0("erreur Sigma naïf ", erreursSigma[i,j,1]))
    erreursSigmaUSOnline = norm(Sigma0 - fitUsOnline$Sigma[n,,],"F")
    erreursSigma[i,j,2] = erreursSigmaUSOnline
    print(paste0("erreur Sigma us online ", erreursSigma[i,j,2]))
    erreursSigmaUSStreaming =  norm(Sigma0 - fitUSStreaming$Sigma[n,,],"F")
    erreursSigma[i,j,3] = erreursSigmaUSStreaming
    print(paste0("erreur Sigma us streaming ", erreursSigma[i,j,3]))
    
    outliers_labelsRecNaive = fitNaif$outliers_labels
    outliers_labelsRecUsOnline = fitUsOnline$outlier_labels
    outliers_labelsRecUsStreaming = fitUSStreaming$outlier_labels
    
    
    if(nb_outliers != 0){
      fn_naive = (sum(outliers_labelsRecNaive == 0 & data$labelsVrais == 1)/(nb_outliers))*100
      faux_negatifsRec[,i,j,1] = fn_naive
      fn_UsOnline = (sum(outliers_labelsRecUsOnline == 0 & data$labelsVrais == 1)/(nb_outliers))*100
      faux_negatifsRec[,i,j,2] = fn_UsOnline
      fn_UsStreaming = sum(outliers_labelsRecUsStreaming == 0 & data$labelsVrais == 1)/(nb_outliers)*100
      faux_negatifsRec[,i,j,3] = fn_UsStreaming
      
    }
    fp_naive = (sum(outliers_labelsRecNaive == 1 & data$labelsVrais == 0)/(nb_inliers))*100
    faux_positifsRec[,i,j,1] = fp_naive
    fp_UsOnline = (sum(outliers_labelsRecUsOnline == 1 & data$labelsVrais == 0)/(nb_inliers))*100
    faux_positifsRec[,i,j,2] = fp_UsOnline
    fp_UsStreaming = (sum(outliers_labelsRecUsStreaming == 1 & data$labelsVrais == 0)/(nb_inliers))*100
    faux_positifsRec[,i,j,3] = fp_UsStreaming
    
    setwd(explDir )
    exploitResFile = paste0('ExploitRes-d', d,  '-n', n, '-k', k1l1val[j,1], '-l', k1l1val[j,2], '-rho', k1l1val[j,3], '-r',r,'-sim', sim,".RData")
    if(nb_outliers != 0){      
      save(erreursSigmaNaive,erreursSigmaUSOnline,erreursSigmaUSStreaming, fn_naive,fn_UsOnline,fn_UsStreaming,fp_naive,fp_UsOnline,fp_UsStreaming,file = exploitResFile)
    }
    else {save(erreursSigmaNaive,erreursSigmaUSOnline,erreursSigmaUSStreaming, fp_naive,fp_UsOnline,fp_UsStreaming,file = exploitResFile)}
    
  }
  
}


# 
# 
# erreursSigma = array(0,dim = c(length(rList),length(kList),3))
# outliers_labelsRec = array(0,dim = c(n,length(rList),length(kList),3))
# labels_vraisRec = matrix(0,n,length(rList))
# 
# 
# k = 0
# rho1 = 0.3
# 
# 
# 
# erreursSigma = array(0,dim = c(length(rList),length(kList),3))
# outliers_labelsRec = array(0,dim = c(n,length(rList),length(kList),3))
# labels_vraisRec = matrix(0,n,length(rList))
# 
# 
# k = 0
# rho1 = 0.3
# 
# sim = 1
# for (i in seq_along(rList) ){
#   setwd(simDir)
#   
#   dataFile <- paste0('SimData-d', d, '-n', n, '-k', k, '-l', 1, '-rho', rho0,'-r',r , '-sim', sim,".RData")
#   load(dataFile)
#   
#   labels_vraisRec[,i] = data$labelsVrais
#   r = rList[i]
#   
#   for (j in seq_along(lList)[4:length(lList)]){
#     l = lList[j]
#     
#     setwd(resDir)
#     
#     fitFile <- paste0('FitParms-d', d,  '-n', n, '-k', k, '-l', l, '-rho', rho1, '-r',r,'-sim', sim,".RData")
#     load(fitFile)
#     
#     erreursSigma[i,(j-3),1] = norm(Sigma0 - fitNaif$Sigma,"F")
#     
#     erreursSigma[i,(j-3),2] = norm(Sigma0 - fitUsOnline$Sigma[n,,],"F")
#     
#     erreursSigma[i,(j-3),3] = norm(Sigma0 - fitUSStreaming$Sigma[n,,],"F")
#     
#     outliers_labelsRec[,i,(j-3),1] = fitNaif$outliers_labels
#     outliers_labelsRec[,i,(j-3),2] = fitUsOnline$outlier_labels
#     outliers_labelsRec[,i,(j-3),3] = fitUSStreaming$outlier_labels
#     
#     
#     
#   }
#   
# }
# 
# 
# 
# erreursSigma = array(0,dim = c(length(rList),length(kList),3))
# outliers_labelsRec = array(0,dim = c(n,length(rList),length(kList),3))
# labels_vraisRec = matrix(0,n,length(rList))
# 
# 
# 
# 
# 
# k = 0
# rho1 = 0.3
# 
# sim = 1
# for (i in seq_along(rList) ){
#   setwd(simDir)
#   
#   dataFile <- paste0('SimData-d', d, '-n', n, '-k', k, '-l', 1, '-rho', rho0,'-r',r , '-sim', sim,".RData")
#   load(dataFile)
#   
#   labels_vraisRec[,i] = data$labelsVrais
#   r = rList[i]
#   setwd(resDir)
#   
#   for (j in seq_along(l1val)[5:length(l1val)]){
#     
#     if(j >= 2){
#     l = lList[j]
#     }
#     
#     fitFile <- paste0('FitParms-d', d,  '-n', n, '-k', k, '-l', l, '-rho', rho1, '-r',r,'-sim', sim,".RData")
#     load(fitFile)
#     
#     erreursSigma[i,(j-3),1] = norm(Sigma0 - fitNaif$Sigma,"F")
#     
#     erreursSigma[i,(j-3),2] = norm(Sigma0 - fitUsOnline$Sigma[n,,],"F")
#     
#     erreursSigma[i,(j-3),3] = norm(Sigma0 - fitUSStreaming$Sigma[n,,],"F")
#     
#     outliers_labelsRec[,i,(j-3),1] = fitNaif$outliers_labels
#     outliers_labelsRec[,i,(j-3),2] = fitUsOnline$outlier_labels
#     outliers_labelsRec[,i,(j-3),3] = fitUSStreaming$outlier_labels
#     
#     
#     
#   }
#   
# }
# 
# 
# sim = 1
# for (i in seq_along(rList) ){
#   setwd(simDir)
#   
#   dataFile <- paste0('SimData-d', d, '-n', n, '-k', k, '-l', 1, '-rho', rho0,'-r',r , '-sim', sim,".RData")
#   load(dataFile)
#   
#   labels_vraisRec[,i] = data$labelsVrais
#   r = rList[i]
#   setwd(resDir)
#   
#   for (j in seq_along(l1val)[5:length(l1val)]){
#     
#     if(j >= 2){
#       l = lList[j]
#     }
#     
#     
#     fitFile <- paste0('FitParms-d', d,  '-n', n, '-k', k, '-l', l, '-rho', rho1, '-r',r,'-sim', sim,".RData")
#     load(fitFile)
#     
#     erreursSigma[i,(j - 3),1] = norm(Sigma0 - fitNaif$Sigma,"F")
#     
#     erreursSigma[i,(j - 3),2] = norm(Sigma0 - fitUsOnline$Sigma[n,,],"F")
#     
#     erreursSigma[i,(j - 3),3] = norm(Sigma0 - fitUSStreaming$Sigma[n,,],"F")
#     
#     outliers_labelsRec[,i,(j - 3),1] = fitNaif$outliers_labels
#     outliers_labelsRec[,i,(j - 3),2] = fitUsOnline$outlier_labels
#     outliers_labelsRec[,i,(j - 3),3] = fitUSStreaming$outlier_labels
#     
#     
#     
#   }
#   
# }
# 
# 
# 
# 
# for (i in seq_along(rList) ) {
# 
#   setwd(resDir)
#   
#   fitFile <- paste0('FitParms-d', d,  '-n', n, '-k', k, '-l', 1, '-rho', rho1, '-r',r,'-sim', sim,".RData")
#   load(fitFile)
#   
#   erreursSigma[i,1,1] = norm(Sigma0 - fitNaif$Sigma,"F")
#   print(paste0("Erreur Fit Naïf ",erreursSigma[i,1,1]))
#   erreursSigma[i,1,2] = norm(Sigma0 - fitUsOnline$Sigma[n,,],"F")
#   print(paste0("Erreur Fit Online ",erreursSigma[i,1,2]))
#   erreursSigma[i,1,3] = norm(Sigma0 - fitUSStreaming$Sigma[n,,],"F")
#   print(paste0("Erreur Fit Streaming ",erreursSigma[i,1,3]))
#   
#   outliers_labelsRec[,i,1,1] = fitNaif$outliers_labels
#   outliers_labelsRec[,i,1,2] = fitUsOnline$outlier_labels
#   outliers_labelsRec[,i,1,3] = fitUSStreaming$outlier_labels
#   
# }
# 
# 
# k = 0
# l = 1
# erreursSigma = array(0,dim = c(length(rList),length(l1val[4:length(l1val)]),3))
# outliers_labelsRec = array(0,dim = c(n,length(rList),length(l1val[4:length(l1val)]),3))
# labels_vraisRec = matrix(0,n,length(rList))
# 
# sim = 1
# #setwd("C:/Users/Paul/Documents/Simus/FitSim")
# for (i in seq_along(rList) ){
#   #setwd(simDir)
#   r = rList[i]
#   
#   # dataFile <- paste0('SimData-d', d, '-n', n, '-k', k, '-l', l, '-rho', rho0,'-r',r , '-sim', sim,".RData")
#   # load(dataFile)
#   # 
#   #labels_vraisRec[,i] = data$labelsVrais
#   print(paste0("r =",r))
#   setwd(resDir)
#   
#     for (j in seq_along(rho1List)){
#     rho1 = rho1List[j]
#     print(paste0("rho1 =",rho1))
#        
#     fitFile <- paste0('FitParms-d', d,  '-n', n, '-k', k, '-l', l, '-rho', rho1, '-r',r,'-sim', sim,".RData")
#     load(fitFile)
#     
#     erreursSigma[i,j,1] = norm(Sigma0 - fitNaif$Sigma,"F")
#     print(paste0("Erreur Fit Naïf ",erreursSigma[i,j,1]))
#     erreursSigma[i,j,2] = norm(Sigma0 - fitUsOnline$Sigma[n,,],"F")
#     print(paste0("Erreur Fit Online ",erreursSigma[i,j,2]))
#     erreursSigma[i,j,3] = norm(Sigma0 - fitUSStreaming$Sigma[n,,],"F")
#     print(paste0("Erreur Fit Streaming ",erreursSigma[i,j,3]))
#     
#     outliers_labelsRec[,i,j,1] = fitNaif$outliers_labels
#     outliers_labelsRec[,i,j,2] = fitUsOnline$outlier_labels
#     outliers_labelsRec[,i,j,3] = fitUSStreaming$outlier_labels
#     
#     
#     
#   }
#   
# }



##################################
#Plots
#################################

# Couleurs communes aux différentes valeurs de KL
kl_colors <- c("blue", "red", "green", "purple")
# Types de lignes pour chaque méthode
line_types <- c(1, 2, 3)  # 1 = plein, 2 = pointillé, 3 = point-virgule

# Créer le plot vide avec la méthode 1 (ligne pleine)
plot(rList, erreursSigma[,1,1], type = "l", col = kl_colors[1], lwd = 2, lty = line_types[1],
     xlab = "r", ylab = "Sigma estimation error",
     ylim = range(erreursSigma, na.rm = TRUE),
     main = "Sigma estimation error for different KL and methods")

# Ajouter les autres valeurs de KL pour la méthode 1 (ligne pleine)
for (kl in 2:4) {
  lines(rList, erreursSigma[,kl,1], col = kl_colors[kl], lwd = 2, lty = line_types[1])
}

# Ajouter les courbes pour la méthode 2 (ligne pointillée)
for (kl in 1:4) {
  lines(rList, erreursSigma[,kl,2], col = kl_colors[kl], lwd = 2, lty = line_types[2])
}

# Ajouter les courbes pour la méthode 3 (ligne point-virgule)
for (kl in 1:4) {
  lines(rList, erreursSigma[,kl,3], col = kl_colors[kl], lwd = 2, lty = line_types[3])
}

# Ajouter une légende combinée
legend("topright",
       legend = c("KL=0 - M1", "KL=1 - M1", "KL=10 - M1", "KL=100 - M1",
                  "KL=0 - M2", "KL=1 - M2", "KL=10 - M2", "KL=100 - M2",
                  "KL=0 - M3", "KL=1 - M3", "KL=10 - M3", "KL=100 - M3"),
       col = rep(kl_colors, times = 3),
       lty = rep(line_types, each = 4),
       lwd = 2, cex = 0.8, bty = "n")



##########################################



