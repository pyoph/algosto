#######################################################
################Directories############################
#######################################################
################à adapter en fonction de votre configuration
##########################################################
<<<<<<< HEAD
simDir <- "D:/Simus/DataSim"
resDir <- "D:/Simus/FitSim"
explDir = "D:/Simus/exploitResults"
=======
simDir <- "~/Simus/DataSim"
resDir <- "~/Simus/FitSim"
explDir = "~/Simus/exploitResults"
>>>>>>> c7a6dc5afc96e6f1332c0781a2f10d145d435c08


d <- 100
rList <- 5*(0:10)
load(paste0('SimParmsGrid-n', n,'-d', d,'.Rdata'))
simNb <- 1

sim=1

#Extraction des paramètres
kList = k1val
lList = l1val
rho1List = rho1val

linf1 = lList[1:4]

lsup1 = c(1,lList[5:7])

# Plutot simNb que n

#############################Exploit results###############################################################################


exploit_results = function(paramList) 
{
 
  erreursSigma = array(0,dim = c(length(rList),length(kList),3))
  erreursSigmaRec = array(0,dim = c(n,length(rList),length(kList),3))
  outliers_labelsRecNaive = rep(0,n)
  outliers_labelsRecUsOnline = rep(0,n)
  outliers_labelsRecUsStreaming = rep(0,n)
  faux_positifsRec = array(0,dim = c(n,length(rList),length(kList),3))
  faux_negatifsRec = array(0,dim = c(n,length(rList),length(kList),3))
  faux_positifsRate = array(0,dim = c(length(rList),length(kList),3))
  faux_negatifsRate = array(0,dim =  c(length(rList),length(kList),3))
  erreursSigmaRec = array(0,dim = c(n,length(rList),length(kList),3))
  labels_vraisRec = matrix(0,n,length(rList))
  
  
  for (i in seq_along(rList) ){
    r = rList[i]
    nb_outliers = r/100*n
    nb_inliers = (1 - r/100)*n
    if(identical(paramList,kList)) 
    {
      rho1 = rho0
      l = 1
    }
    if(identical(paramList,lList[1:4]) | identical(paramList,lsup1)) 
    {
      k = 0
      rho1 = rho0
      
    }
    
    
    
    if(identical(paramList,rho1List)) 
    {
      k = 0
      l = 1
      
    }
    
    
    
    for (j in seq_along(paramList)){
      #rho1 = rho1val[j]
      #print(paste0("rho1 =",rho))
      setwd(simDir)
      if(identical(paramList,kList)) {k = paramList[j]}
      if(identical(paramList,lList[1:4])){l = lList[j]}
      if(identical(paramList,lsup1)){l = lsup1[j]}
      if(identical(paramList,rho1List)){rho1 = rho1List[j]}
      dataFile <- paste0('SimData-d', d, '-n', n, '-k', k, '-l', l, '-rho', rho1,'-r',r , '-sim', sim,".RData")
      
      if(!file.exists(dataFile)){
        contParam = ParmsF1(m1, k, l, rho1)
        
        data = genererEchantillon(n,n,mu1 = mu0,mu2 = contParam$mu1,Sigma1 = Sigma0,Sigma2 = contParam$Sigma1,r )
        save(data, file=dataFile)
        print(paste0("n-",n,"d-",d,"k-",k,"l-",l,"r-",r," save ok"))
        
      }
      #load(file = dataFile)
      load(dataFile)
      
      labels_vraisRec[,i] = data$labelsVrais
      
      
      setwd(resDir)
      
      #fitFile <- paste0('FitParms-d', d,  '-n', n, '-k', k, '-l', l, '-rho', rho1, '-r',r,'-sim', sim,".RData")
      #if(!file.exists(fitFile )){
        temps_naif = system.time(
          {fitNaif <- SampleCovOnline(data$Z)})
        print(paste0("Erreur Naif = ",norm(fitNaif$Sigma - Sigma0,"F")))
        temps_online  = system.time({fitUsOnline <- StreamingOutlierDetection(data$Z,batch = 1,cutoff = 1.27 * qchisq(0.95, df = d))})
        print(norm(fitUsOnline$Sigma[n,,] - Sigma0,"F"))
        print(paste0("Erreur online = ",norm(fitUsOnline$Sigma[n,,] - Sigma0,"F")))
        #Changer cutoff si d = 100
        temps_streaming = system.time({fitUSStreaming =StreamingOutlierDetection(data$Z,batch = sqrt(ncol(data$Z)),cutoff = 1.38*qchisq(0.95,df = d))})
        print(norm(fitUSStreaming$Sigma[n,,] - Sigma0,"F"))
        print(paste0("Erreur streaming = ",norm(fitUSStreaming$Sigma[n,,] - Sigma0,"F")))
        
        setwd(resDir)
      #  save(fitNaif, fitUsOnline, fitUSStreaming,temps_naif,temps_online,temps_streaming,file=fitFile)
<<<<<<< HEAD
      }
=======
      #}
>>>>>>> c7a6dc5afc96e6f1332c0781a2f10d145d435c08
      #load(fitFile)
      
      erreursSigmaNaive = norm(Sigma0 - fitNaif$Sigma,"F")
      erreursSigma[i,j,1] = erreursSigmaNaive
      
      for (s in (1:n))
      {
        erreursSigmaRec[s,i,j,1] = norm(Sigma0 - fitNaif$SigmaIter[s,,],"F")
        erreursSigmaRec[s,i,j,2] = norm(Sigma0 - fitUsOnline$Sigma[s,,],"F")
        erreursSigmaRec[s,i,j,3] = norm(Sigma0 - fitUSStreaming$Sigma[s,,],"F")
      }
      
      
      print(paste0("erreur Sigma naïf ", erreursSigma[i,j,1]))
      erreursSigmaUSOnline = norm(Sigma0 - fitUsOnline$Sigma[n,,],"F")
      erreursSigma[i,j,2] = erreursSigmaUSOnline
      print(paste0("erreur Sigma us online ", erreursSigma[i,j,2]))
      erreursSigmaUSStreaming =  norm(Sigma0 - fitUSStreaming$Sigma[n,,],"F")
      erreursSigma[i,j,3] = erreursSigmaUSStreaming
      print(paste0("erreur Sigma us streaming ", erreursSigma[i,j,3]))
      
      outliers_labelsRecNaive = fitNaif$outliers_labels
      outliers_labelsRecUsOnline = fitUsOnline$outlier_labels
      outliers_labelsRecUsStreaming = fitUSStreaming$outlier_labels
      
      for (k in (1:n))
      {
        erreursSigmaRec[k,i,j,1] = norm(Sigma0 - fitNaif$SigmaIter[k,,],"F")
        
        erreursSigmaRec[k,i,j,2] = norm(Sigma0 - fitUsOnline$Sigma[k,,],"F")
        erreursSigmaRec[k,i,j,3] = norm(Sigma0 - fitUSStreaming$Sigma[k,,],"F")
        
      }
      erreursSigmaNaiveRec = erreursSigmaRec[,i,j,1]
      erreursSigmaUsOnlineRec = erreursSigmaRec[,i,j,2]
      erreursSigmaUsStreamingRec = erreursSigmaRec[,i,j,3]
      
      if(nb_outliers != 0){
        fn_naive = (sum(outliers_labelsRecNaive == 0 & data$labelsVrais == 1)/(nb_outliers))*100
        faux_negatifsRate[i,j,1] = fn_naive
        
        fn_UsOnline = (sum(outliers_labelsRecUsOnline == 0 & data$labelsVrais == 1)/(nb_outliers))*100
        faux_negatifsRate[i,j,2] = fn_UsOnline
        fn_UsStreaming = sum(outliers_labelsRecUsStreaming == 0 & data$labelsVrais == 1)/(nb_outliers)*100
        faux_negatifsRate[i,j,3] = fn_UsStreaming
        
      }
      fp_naive = (sum(outliers_labelsRecNaive == 1 & data$labelsVrais == 0)/(nb_inliers))*100
      faux_positifsRate[i,j,1] = fp_naive
      fp_UsOnline = (sum(outliers_labelsRecUsOnline == 1 & data$labelsVrais == 0)/(nb_inliers))*100
      faux_positifsRate[i,j,2] = fp_UsOnline
      fp_UsStreaming = (sum(outliers_labelsRecUsStreaming == 1 & data$labelsVrais == 0)/(nb_inliers))*100
      faux_positifsRate[i,j,3] = fp_UsStreaming
      
      setwd(explDir )
      exploitResFile = paste0('ExploitRes-d', d,  '-n', n, '-k', k, '-l', l, '-rho', rho1, '-r',r,'-sim', sim,".RData")
<<<<<<< HEAD
      if(nb_outliers != 0){      
        save(erreursSigmaNaive,erreursSigmaUSOnline,erreursSigmaUSStreaming, fn_naive,fn_UsOnline,fn_UsStreaming,fp_naive,fp_UsOnline,fp_UsStreaming,file = exploitResFile)
      }
      else {save(erreursSigmaNaive,erreursSigmaUSOnline,erreursSigmaUSStreaming,fp_naive,fp_UsOnline,fp_UsStreaming,file = exploitResFile)}
      
=======
      # if(nb_outliers != 0){      
      #   #save(erreursSigmaNaive,erreursSigmaUSOnline,erreursSigmaUSStreaming, fn_naive,fn_UsOnline,fn_UsStreaming,fp_naive,fp_UsOnline,fp_UsStreaming,file = exploitResFile)
      # }
      # else {save(erreursSigmaNaive,erreursSigmaUSOnline,erreursSigmaUSStreaming, fp_naive,fp_UsOnline,fp_UsStreaming,file = exploitResFile)}
      #system(paste0("mc cp /home/onyxia/work/Simus/FitSim/",fitFile," s3/projet-datalab-guillot-paul/"))
      #system(paste0("rm ",fitFile))
>>>>>>> c7a6dc5afc96e6f1332c0781a2f10d145d435c08
    }
  }
  return(list(erreursSigma = erreursSigma,erreursSigmaRec = erreursSigmaRec,faux_negatifsRate = faux_negatifsRate,faux_positifsRate = faux_positifsRate ))
}  


##########################Plots###############################################################################################
plot_results <- function(title, ylab, ylim, results, show_legend = TRUE) {
  kl_colors <- c("blue", "red", "green", "purple")
  line_types <- c(1, 2, 3)
  
  plot(rList, results[,1,1], type = "l", col = kl_colors[1], lwd = 2, lty = line_types[1],
       xlab = "", ylab = ylab,
       ylim = ylim,
       main = title)
  
  for (kl in 2:4) {
    lines(rList, results[,kl,1], col = kl_colors[kl], lwd = 2, lty = line_types[1])
  }
  for (kl in 1:4) {
    lines(rList, results[,kl,2], col = kl_colors[kl], lwd = 2, lty = line_types[2])
    lines(rList, results[,kl,3], col = kl_colors[kl], lwd = 2, lty = line_types[3])
  }
  
  if (show_legend) {
    legend("topright",
           legend = c("KL=0 - Sample Cov Online", "KL=1 - Sample Cov Online", "KL=10 - Sample Cov Online", "KL=100 - Sample Cov Online",
                      "KL=0 - Online us", "KL=1 - Online us", "KL=10 - Online us", "KL=100 - Online us",
                      "KL=0 - Streaming us", "KL=1 - Streaming us", "KL=10 - Streaming us", "KL=100 - Streaming us"),
           col = rep(kl_colors, times = 3),
           lty = rep(line_types, each = 4),
           lwd = 2, cex = 0.8, bty = "n")
  }
}

#################################################################Execution of functions#######################################


exresk = exploit_results(kList)
exreslinf1 = exploit_results(linf1)
exreslsup1 = exploit_results(lsup1)
exresrho1 = exploit_results(rho1List)

erreursSigmak = exresk$erreursSigma
erreursSigmalinf1 = exreslinf1$erreursSigma
erreursSigmalsup1 = exreslsup1$erreursSigma
erreursSigmaRho1 = exresrho1$erreursSigma
# Création de la disposition : 4 plots + 1 zone pour la légende
layout_matrix <- matrix(c(
  1, 2,
  3, 4,
  5, 5  # 5 = légende commune
), nrow = 3, byrow = TRUE)

layout(layout_matrix, heights = c(1, 1, 0.4))  # plus petit pour la légende

# Marges standards pour les plots
par(mar = c(4, 4, 2, 1))

# Les 4 sous-graphes sans légende
plot_results("k varying", ylim = c(0, 100), ylab = "Frobenius norm error", erreursSigmak, show_legend = FALSE)
plot_results("l <= 1 varying", ylim = c(0, 100), ylab = "", erreursSigmalinf1, show_legend = FALSE)
plot_results("l => 1 varying", ylim = c(0, 100), ylab = "Frobenius norm error", erreursSigmalsup1, show_legend = FALSE)
plot_results("rho1 varying", ylim = c(0, 100), ylab = "", erreursSigmaRho1, show_legend = FALSE)

# Zone pour la légende
par(mar = c(0, 0, 0, 0))  # pas de marges
plot.new()
# Ajoute le titre global avant la légende
#mtext("Frobenius norm error for variations of k l and rho1", outer = TRUE, line = -1, cex = 1, font = 1)

legend("center",
       legend = c("KL=0 - Sample Cov Online", "KL=1 - Sample Cov Online", "KL=10 - Sample Cov Online", "KL=100 - Sample Cov Online",
                  "KL=0 - Online us", "KL=1 - Online us", "KL=10 - Online us", "KL=100 - Online us",
                  "KL=0 - Streaming us", "KL=1 - Streaming us", "KL=10 - Streaming us", "KL=100 - Streaming us"),
       col = rep(c("blue", "red", "green", "purple"), times = 3),
       lty = rep(c(1, 2, 3), each = 4),
       lwd = 2, cex = 1.2, bty = "n", ncol = 3)


false_negativesk = exresk$faux_negatifsRate
false_negativeslinf1 = exreslinf1$faux_negatifsRate
false_negativeslsup1 = exreslsup1$faux_negatifsRate
false_negativesrho1 = exresrho1$faux_negatifsRate


layout(layout_matrix, heights = c(1, 1, 0.4))  # plus petit pour la légende

# Marges standards pour les plots
par(mar = c(4, 4, 2, 1))

# Les 4 sous-graphes sans légende
plot_results("k varying", ylim = c(0, 100), ylab = "False negatives", false_negativesk, show_legend = FALSE)
plot_results("l <= 1 varying", ylim = c(0, 100), ylab = "", false_negativeslinf1, show_legend = FALSE)
plot_results("l => 1 varying", ylim = c(0, 100), ylab = "False negatives", false_negativeslsup1, show_legend = FALSE)
plot_results("rho1 varying", ylim = c(0, 100), ylab = "", false_negativesrho1, show_legend = FALSE)

# Zone pour la légende
par(mar = c(0, 0, 0, 0))  # pas de marges
plot.new()
# Ajoute le titre global avant la légende
#mtext("Frobenius norm error for variations of k l and rho1", outer = TRUE, line = -1, cex = 1, font = 1)

legend("center",
       legend = c("KL=0 - Sample Cov Online", "KL=1 - Sample Cov Online", "KL=10 - Sample Cov Online", "KL=100 - Sample Cov Online",
                  "KL=0 - Online us", "KL=1 - Online us", "KL=10 - Online us", "KL=100 - Online us",
                  "KL=0 - Streaming us", "KL=1 - Streaming us", "KL=10 - Streaming us", "KL=100 - Streaming us"),
       col = rep(c("blue", "red", "green", "purple"), times = 3),
       lty = rep(c(1, 2, 3), each = 4),
       lwd = 2, cex = 1.2, bty = "n", ncol = 3)

