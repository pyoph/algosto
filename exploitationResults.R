#######################################################
################Directories############################
#######################################################
################à adapter en fonction de votre configuration
##########################################################
simDir <- "~/Simus/DataSim"
resDir <- "~/Simus/FitSim"
explDir = "~/Simus/exploitResults"

setwd("~/algosto")
d <- 100
rList <- 5*(0:10)
load(paste0('SimParmsGrid-n', n,'-d', d,'.Rdata'))
simNb <- 1

sim=1


#Extraction des paramètres
kList = k1val
lList = l1val
rho1List = rho1val

linf1 = lList[1:4]

lsup1 = c(1,lList[5:7])

rho1ListNeg = rho1valNeg
# Plutot simNb que n

#############################Exploit results k, l, rho varying###############################################################################


# exploit_results = function(paramList,sim) 
# {
#  
#   
#   erreursSigma = array(0,dim = c(length(rList),length(kList),3))
#   erreursSigmaRec = array(0,dim = c(n,length(rList),length(kList),3))
#   outliers_labelsRecNaive = rep(0,n)
#   outliers_labelsRecUsOnline = rep(0,n)
#   outliers_labelsRecUsStreaming = rep(0,n)
#   faux_positifsRec = array(0,dim = c(n,length(rList),length(kList),3))
#   faux_negatifsRec = array(0,dim = c(n,length(rList),length(kList),3))
#   faux_positifsRate = array(0,dim = c(length(rList),length(kList),3))
#   faux_negatifsRate = array(0,dim =  c(length(rList),length(kList),3))
#   erreursSigmaRec = array(0,dim = c(n,length(rList),length(kList),3))
#   labels_vraisRec = matrix(0,n,length(rList))
#   
#   
#   for (i in seq_along(rList) ){
#     r = rList[i]
#     nb_outliers = r/100*n
#     nb_inliers = (1 - r/100)*n
#     if(identical(paramList,kList)) 
#     {
#       rho1 = rho0
#       l = 1
#       print(paste0("n-",n,"d-",d,"k-",k,"l-",l,"rho1-",rho1," r-",r,"-sim",sim))
#       
#     }
#     if(identical(paramList,lList[1:4]) | identical(paramList,lsup1)) 
#     {
#       k = 0
#       rho1 = rho0
#       print(paste0("n-",n,"d-",d,"k-",k,"l-",l,"rho1-",rho1," r-",r,"-sim",sim))
#       
#     }
#     
#     
#     
#     if(identical(paramList,rho1List)) 
#     {
#       k = 0
#       l = 1
# 
#     }
#     
#     
#     for (j in seq_along(paramList)){
#       #rho1 = rho1val[j]
#       #print(paste0("rho1 =",rho))
#       setwd(simDir)
#       if(identical(paramList,kList)) {k = paramList[j]
#       print(paste0("j = ",j))
#       print(paste0("k =",k))}
#       if(identical(paramList,lList[1:4])){l = lList[j]
#       print(paste0("n-",n,"d-",d,"k-",k,"l-",l,"rho1-",rho1," r-",r,"-sim",sim))
#       }
#       if(identical(paramList,lsup1)){l = lsup1[j]
#       print(paste0("n-",n,"d-",d,"k-",k,"l-",l,"rho1-",rho1," r-",r,"-sim",sim))
#       }
#       if(identical(paramList,rho1List)){rho1 = rho1List[j]}
#       dataFile <- paste0('SimData-d', d, '-n', n, '-k', k, '-l', l, '-rho', rho1,'-r',r , '-sim', sim,".RData")
#       
#       if(!file.exists(dataFile)){
#         contParam = ParmsF1(m1, k, l, rho1)
#         
#         data = genererEchantillon(n,n,mu1 = mu0,mu2 = contParam$mu1,Sigma1 = Sigma0,Sigma2 = contParam$Sigma1,r )
#         save(data, file=dataFile)
#         print(paste0("n-",n,"d-",d,"k-",k,"l-",l,"r-",r,"-sim",sim," save ok"))
#         
#       }
#       load(dataFile)
#       
#       labels_vraisRec[,i] = data$labelsVrais
#       
#       
#       setwd(resDir)
#       
#       fitFile <- paste0('FitParms-d', d,  '-n', n, '-k', k, '-l', l, '-rho', rho1, '-r',r,'-sim', sim,".RData")
#       if(!file.exists(fitFile )){
#         temps_naif = system.time(
#           {fitNaif <- SampleCovOnline(data$Z)})
#         print(paste0("Erreur Naif = ",norm(fitNaif$Sigma - Sigma0,"F")))
#         temps_online  = system.time({fitUsOnline <- StreamingOutlierDetection(data$Z,batch = 1)})
#         print(norm(fitUsOnline$Sigma[n,,] - Sigma0,"F"))
#         print(paste0("Erreur online = ",norm(fitUsOnline$Sigma[n,,] - Sigma0,"F")))
#         #Changer cutoff si d = 100
#         if(d == 100){temps_streaming = system.time({fitUSStreaming =StreamingOutlierDetection(data$Z,batch = sqrt(ncol(data$Z)),cutoff = 1.38*qchisq(0.95,df = d))})}
#         if(d == 10){temps_streaming = system.time({fitUSStreaming =StreamingOutlierDetection(data$Z,batch = ncol(data$Z))})}
#         print(norm(fitUSStreaming$Sigma[n,,] - Sigma0,"F"))
#         print(paste0("Erreur streaming = ",norm(fitUSStreaming$Sigma[n,,] - Sigma0,"F")))
#         
#         setwd(resDir)
#         save(fitNaif, fitUsOnline, fitUSStreaming,temps_naif,temps_online,temps_streaming,file=fitFile)
# 
#       }
#       load(fitFile)
# 
#       erreursSigmaNaive = norm(Sigma0 - fitNaif$Sigma,"F")
#       erreursSigma[i,j,1] = erreursSigmaNaive
#       
#       for (s in (1:n))
#       {
#         erreursSigmaRec[s,i,j,1] = norm(Sigma0 - fitNaif$SigmaIter[s,,],"F")
#         erreursSigmaRec[s,i,j,2] = norm(Sigma0 - fitUsOnline$Sigma[s,,],"F")
#         erreursSigmaRec[s,i,j,3] = norm(Sigma0 - fitUSStreaming$Sigma[s,,],"F")
#       }
#       
#       
#       print(paste0("erreur Sigma naïf ", erreursSigma[i,j,1]))
#       erreursSigmaUSOnline = norm(Sigma0 - fitUsOnline$Sigma[n,,],"F")
#       erreursSigma[i,j,2] = erreursSigmaUSOnline
#       print(paste0("erreur Sigma us online ", erreursSigma[i,j,2]))
#       erreursSigmaUSStreaming =  norm(Sigma0 - fitUSStreaming$Sigma[n,,],"F")
#       erreursSigma[i,j,3] = erreursSigmaUSStreaming
#       print(paste0("erreur Sigma us streaming ", erreursSigma[i,j,3]))
#       if(d == 10){
#       outliers_labelsRecNaive = fitNaif$outliers_labels
#       outliers_labelsRecUsOnline = fitUsOnline$outlier_labels
#       outliers_labelsRecUsStreaming = fitUSStreaming$outlier_labels
#       }
#       if(d == 100){
#         outliers_labelsRecNaive = test_outliers(fitNaif$distances,cutoff = qchisq(.95,df = 1e2))
#         outliers_labelsRecUsOnline = test_outliers(fitUsOnline$distances,cutoff = 1.29*qchisq(.95,df = 1e2))
#         outliers_labelsRecUsStreaming = test_outliers(fitUSStreaming$distances,cutoff = 1.38*qchisq(.95,df = 1e2))
#         
#       }
#       for (s in (1:n))
#       {
#         erreursSigmaRec[s,i,j,1] = norm(Sigma0 - fitNaif$SigmaIter[s,,],"F")
#         
#         erreursSigmaRec[s,i,j,2] = norm(Sigma0 - fitUsOnline$Sigma[s,,],"F")
#         erreursSigmaRec[s,i,j,3] = norm(Sigma0 - fitUSStreaming$Sigma[s,,],"F")
#         
#       }
#       erreursSigmaNaiveRec = erreursSigmaRec[,i,j,1]
#       erreursSigmaUsOnlineRec = erreursSigmaRec[,i,j,2]
#       erreursSigmaUsStreamingRec = erreursSigmaRec[,i,j,3]
#       
#       if(nb_outliers != 0){
#         fn_naive = (sum(outliers_labelsRecNaive == 0 & data$labelsVrais == 1)/(nb_outliers))*100
#         faux_negatifsRate[i,j,1] = fn_naive
#         
#         print(paste0("FN naïve ",fn_naive))
#         fn_UsOnline = (sum(outliers_labelsRecUsOnline == 0 & data$labelsVrais == 1)/(nb_outliers))*100
#         print(paste0("FN Us Online ",fn_UsOnline))
#         
#         faux_negatifsRate[i,j,2] = fn_UsOnline
#         fn_UsStreaming = sum(outliers_labelsRecUsStreaming == 0 & data$labelsVrais == 1)/(nb_outliers)*100
#         print(paste0("FN Us Streaming ",fn_UsStreaming))
#         faux_negatifsRate[i,j,3] = fn_UsStreaming
#         
#       }
#       fp_naive = (sum(outliers_labelsRecNaive == 1 & data$labelsVrais == 0)/(nb_inliers))*100
#       
#       print(paste0("FP naïve ",fp_naive))
#       faux_positifsRate[i,j,1] = fp_naive
#       fp_UsOnline = (sum(outliers_labelsRecUsOnline == 1 & data$labelsVrais == 0)/(nb_inliers))*100
#       
#       print(paste0("FP us online  ",fp_UsOnline))
#       faux_positifsRate[i,j,2] = fp_UsOnline
#       fp_UsStreaming = (sum(outliers_labelsRecUsStreaming == 1 & data$labelsVrais == 0)/(nb_inliers))*100
#       faux_positifsRate[i,j,3] = fp_UsStreaming
#       
#       print(paste0("FP us streaming  ",fp_UsStreaming))
#       setwd(explDir )
#       exploitResFile = paste0('ExploitRes-d', d,  '-n', n, '-k', k, '-l', l, '-rho', rho1, '-r',r,'-sim', sim,".RData")
#       if(nb_outliers != 0){      
#         save(erreursSigmaNaive,erreursSigmaNaiveRec,erreursSigmaUSOnline,erreursSigmaUsOnlineRec,erreursSigmaUSStreaming, erreursSigmaUsStreamingRec,fn_naive,fn_UsOnline,fn_UsStreaming,fp_naive,fp_UsOnline,fp_UsStreaming,file = exploitResFile)
#       }
#       else {save(erreursSigmaNaive,erreursSigmaNaiveRec,erreursSigmaUSOnline,erreursSigmaUsOnlineRec,erreursSigmaUSStreaming,erreursSigmaUsStreamingRec,fp_naive,fp_UsOnline,fp_UsStreaming,file = exploitResFile)}
#       
#       # if(nb_outliers != 0){      
#       #   #save(erreursSigmaNaive,erreursSigmaUSOnline,erreursSigmaUSStreaming, fn_naive,fn_UsOnline,fn_UsStreaming,fp_naive,fp_UsOnline,fp_UsStreaming,file = exploitResFile)
#       # }
#       # else {save(erreursSigmaNaive,erreursSigmaUSOnline,erreursSigmaUSStreaming, fp_naive,fp_UsOnline,fp_UsStreaming,file = exploitResFile)}
#       #system(paste0("mc cp /home/onyxia/work/Simus/FitSim/",fitFile," s3/projet-datalab-guillot-paul/"))
#       #system(paste0("rm ",fitFile))
#     }
#   }
#   return(list(erreursSigma = erreursSigma,erreursSigmaRec = erreursSigmaRec,faux_negatifsRate = faux_negatifsRate,faux_positifsRate = faux_positifsRate ))
# }  

erreursSigmak = array(0,dim = c(length(rList),length(kList),3))
faux_negatifsRatek = array(0,dim = c(length(rList),length(kList),3))
faux_positifsRatek = array(0,dim = c(length(rList),length(kList),3))
l = 1
rho1 = rho0
for (i in seq_along(rList)){
  r = rList[i]
  nb_outliers = r/100*n
  nb_inliers = (1 - r/100)*n
  for (j in seq_along(kList)){
    k = kList[j]
    dataFile <- paste0('SimData-d', d, '-n', n, '-k', k, '-l', l, '-rho', rho1,'-r',r , '-sim', sim,".RData")

  if(!file.exists(dataFile)){
  contParam = ParmsF1(m1, k, l, rho1)

  data = genererEchantillon(n,n,mu1 = mu0,mu2 = contParam$mu1,Sigma1 = Sigma0,Sigma2 = contParam$Sigma1,r )
  save(data, file=dataFile)
  print(paste0("n-",n,"d-",d,"k-",k,"l-",l,"r-",r,"-sim",sim," save ok"))

    }
    load(dataFile)


    fitFile <- paste0('FitParms-d', d,  '-n', n, '-k', k, '-l', l, '-rho', rho1, '-r',r,'-sim', sim,".RData")
    if(!file.exists(fitFile )){
      temps_naif = system.time(
        {fitNaif <- SampleCovOnline(data$Z)})
      print(paste0("Erreur Naif = ",norm(fitNaif$Sigma - Sigma0,"F")))
      if(d == 10){temps_online  = system.time({fitUsOnline <- StreamingOutlierDetection(data$Z,batch = 1)})}
      if(d == 100){temps_streaming = system.time({fitUSStreaming =StreamingOutlierDetection(data$Z,batch = 1,cutoff = 1.29*qchisq(0.95,df = d))})}
      
      print(norm(fitUsOnline$Sigma[n,,] - Sigma0,"F"))
      print(paste0("Erreur online = ",norm(fitUsOnline$Sigma[n,,] - Sigma0,"F")))
      #Changer cutoff si d = 100
      if(d == 100){temps_streaming = system.time({fitUSStreaming =StreamingOutlierDetection(data$Z,batch = sqrt(ncol(data$Z)),cutoff = 1.38*qchisq(0.95,df = d))})}
      if(d == 10){temps_streaming = system.time({fitUSStreaming =StreamingOutlierDetection(data$Z,batch = ncol(data$Z))})}
      print(norm(fitUSStreaming$Sigma[n,,] - Sigma0,"F"))
      print(paste0("Erreur streaming = ",norm(fitUSStreaming$Sigma[n,,] - Sigma0,"F")))
      
      setwd(resDir)
      if(d == 10){save(fitNaif, fitUsOnline, fitUSStreaming,temps_naif,temps_online,temps_streaming,file=fitFile)}
      
    }
    if(file.exists(fitFile)){load(fitFile)}
    print(paste0("Erreur Naif = ",norm(fitNaif$Sigma - Sigma0,"F")))
    print(paste0("Erreur online = ",norm(fitUsOnline$Sigma[n,,] - Sigma0,"F")))
    print(paste0("Erreur streaming = ",norm(fitUSStreaming$Sigma[n,,] - Sigma0,"F")))
    erreursSigmak[i,j,1] = norm(fitNaif$Sigma - Sigma0,"F")
    erreursSigmak[i,j,2] = norm(fitUsOnline$Sigma[n,,] - Sigma0,"F")
    erreursSigmak[i,j,3] = norm(fitUSStreaming$Sigma[n,,] - Sigma0,"F")
    
    outliers_labelsRecNaive = fitNaif$outliers_labels
    outliers_labelsRecUsOnline = fitUsOnline$outlier_labels
    outliers_labelsRecUsStreaming = fitUSStreaming$outlier_labels
    
    if(nb_outliers != 0){
              fn_naive = (sum(outliers_labelsRecNaive == 0 & data$labelsVrais == 1)/(nb_outliers))*100
              faux_negatifsRatek[i,j,1] = fn_naive

              print(paste0("FN naïve ",fn_naive))
              fn_UsOnline = (sum(outliers_labelsRecUsOnline == 0 & data$labelsVrais == 1)/(nb_outliers))*100
              print(paste0("FN Us Online ",fn_UsOnline))

              faux_negatifsRatek[i,j,2] = fn_UsOnline
              fn_UsStreaming = sum(outliers_labelsRecUsStreaming == 0 & data$labelsVrais == 1)/(nb_outliers)*100
              print(paste0("FN Us Streaming ",fn_UsStreaming))
              faux_negatifsRatek[i,j,3] = fn_UsStreaming

            }
            fp_naive = (sum(outliers_labelsRecNaive == 1 & data$labelsVrais == 0)/(nb_inliers))*100

            print(paste0("FP naïve ",fp_naive))
            faux_positifsRatek[i,j,1] = fp_naive
            fp_UsOnline = (sum(outliers_labelsRecUsOnline == 1 & data$labelsVrais == 0)/(nb_inliers))*100

            print(paste0("FP us online  ",fp_UsOnline))
            faux_positifsRatek[i,j,2] = fp_UsOnline
            fp_UsStreaming = (sum(outliers_labelsRecUsStreaming == 1 & data$labelsVrais == 0)/(nb_inliers))*100
            faux_positifsRatek[i,j,3] = fp_UsStreaming

            print(paste0("FP us streaming  ",fp_UsStreaming))

  }
}

erreursSigmalinf1 = array(0,dim = c(length(rList),length(linf1),3))
faux_negatifsRatelinf1 = array(0,dim = c(length(rList),length(linf1),3))
faux_positifsRatelinf1 = array(0,dim = c(length(rList),length(linf1),3))


k = 0
rho1 = rho0
for (i in seq_along(rList)){
  r = rList[i]
  nb_outliers = r/100*n
  nb_inliers = (1 - r/100)*n
  for (j in seq_along(linf1)){
    
    l = linf1[j]
    
    dataFile <- paste0('SimData-d', d, '-n', n, '-k', k, '-l', l, '-rho', rho1,'-r',r , '-sim', sim,".RData")
    
    if(!file.exists(dataFile)){
      contParam = ParmsF1(m1, k, l, rho1)
      
      data = genererEchantillon(n,n,mu1 = mu0,mu2 = contParam$mu1,Sigma1 = Sigma0,Sigma2 = contParam$Sigma1,r )
      save(data, file=dataFile)
      print(paste0("n-",n,"d-",d,"k-",k,"l-",l,"r-",r,"-sim",sim," save ok"))
      
    }
    load(dataFile)
    
    fitFile <- paste0('FitParms-d', d,  '-n', n, '-k', k, '-l', l, '-rho', rho1, '-r',r,'-sim', sim,".RData")
    if(!file.exists(fitFile )){
      temps_naif = system.time(
        {fitNaif <- SampleCovOnline(data$Z)})
      print(paste0("Erreur Naif = ",norm(fitNaif$Sigma - Sigma0,"F")))
      temps_online  = system.time({fitUsOnline <- StreamingOutlierDetection(data$Z,batch = 1)})
      print(norm(fitUsOnline$Sigma[n,,] - Sigma0,"F"))
      print(paste0("Erreur online = ",norm(fitUsOnline$Sigma[n,,] - Sigma0,"F")))
      #Changer cutoff si d = 100
      if(d == 100){temps_streaming = system.time({fitUSStreaming =StreamingOutlierDetection(data$Z,batch = sqrt(ncol(data$Z)),cutoff = 1.38*qchisq(0.95,df = d))})}
      if(d == 10){temps_streaming = system.time({fitUSStreaming =StreamingOutlierDetection(data$Z,batch = ncol(data$Z))})}
      print(norm(fitUSStreaming$Sigma[n,,] - Sigma0,"F"))
      print(paste0("Erreur streaming = ",norm(fitUSStreaming$Sigma[n,,] - Sigma0,"F")))
      
      setwd(resDir)
      if(d == 10){save(fitNaif, fitUsOnline, fitUSStreaming,temps_naif,temps_online,temps_streaming,file=fitFile)}
      
    }
    if(file.exists(fitFile)){load(fitFile)}
    #load(fitFile)
    print(paste0("Erreur Naif = ",norm(fitNaif$Sigma - Sigma0,"F")))
    print(paste0("Erreur online = ",norm(fitUsOnline$Sigma[n,,] - Sigma0,"F")))
    print(paste0("Erreur streaming = ",norm(fitUSStreaming$Sigma[n,,] - Sigma0,"F")))
    erreursSigmalinf1[i,j,1] = norm(fitNaif$Sigma - Sigma0,"F")
    erreursSigmalinf1[i,j,2] = norm(fitUsOnline$Sigma[n,,] - Sigma0,"F")
    erreursSigmalinf1[i,j,3] = norm(fitUSStreaming$Sigma[n,,] - Sigma0,"F")
  
    outliers_labelsRecNaive = fitNaif$outliers_labels
    outliers_labelsRecUsOnline = fitUsOnline$outlier_labels
    outliers_labelsRecUsStreaming = fitUSStreaming$outlier_labels
    
    if(nb_outliers != 0){
      fn_naive = (sum(outliers_labelsRecNaive == 0 & data$labelsVrais == 1)/(nb_outliers))*100
      faux_negatifsRatelinf1[i,j,1] = fn_naive
      
      print(paste0("FN naïve ",fn_naive))
      fn_UsOnline = (sum(outliers_labelsRecUsOnline == 0 & data$labelsVrais == 1)/(nb_outliers))*100
      print(paste0("FN Us Online ",fn_UsOnline))
      
      faux_negatifsRatelinf1[i,j,2] = fn_UsOnline
      fn_UsStreaming = sum(outliers_labelsRecUsStreaming == 0 & data$labelsVrais == 1)/(nb_outliers)*100
      print(paste0("FN Us Streaming ",fn_UsStreaming))
      faux_negatifsRatelinf1[i,j,3] = fn_UsStreaming
      
    }
    fp_naive = (sum(outliers_labelsRecNaive == 1 & data$labelsVrais == 0)/(nb_inliers))*100
    
    print(paste0("FP naïve ",fp_naive))
    faux_positifsRatelinf1[i,j,1] = fp_naive
    fp_UsOnline = (sum(outliers_labelsRecUsOnline == 1 & data$labelsVrais == 0)/(nb_inliers))*100
    
    print(paste0("FP us online  ",fp_UsOnline))
    faux_positifsRatelinf1[i,j,2] = fp_UsOnline
    fp_UsStreaming = (sum(outliers_labelsRecUsStreaming == 1 & data$labelsVrais == 0)/(nb_inliers))*100
    faux_positifsRatelinf1[i,j,3] = fp_UsStreaming
    
    print(paste0("FP us streaming  ",fp_UsStreaming))
    
  }
    }



erreursSigmalsup1 = array(0,dim = c(length(rList),length(lsup1),3))
faux_negatifsRatelsup1 = array(0,dim = c(length(rList),length(lsup1),3))
faux_positifsRatelsup1 = array(0,dim = c(length(rList),length(lsup1),3))
k = 0
rho1 = rho0
for (i in seq_along(rList)){
  r = rList[i]
  nb_outliers = r/100*n
  nb_inliers = (1 - r/100)*n
  for (j in seq_along(lsup1)){
    l = lsup1[j]
    
    dataFile <- paste0('SimData-d', d, '-n', n, '-k', k, '-l', l, '-rho', rho1,'-r',r , '-sim', sim,".RData")
    print(dataFile)
    if(!file.exists(dataFile)){
      contParam = ParmsF1(m1, k, l, rho1)
      
      data = genererEchantillon(n,n,mu1 = mu0,mu2 = contParam$mu1,Sigma1 = Sigma0,Sigma2 = contParam$Sigma1,r )
      save(data, file=dataFile)
      print(paste0("n-",n,"d-",d,"k-",k,"l-",l,"r-",r,"-sim",sim," save ok"))
      
    }
    load(dataFile)
    fitFile <- paste0('FitParms-d', d,  '-n', n, '-k', k, '-l', l, '-rho', rho1, '-r',r,'-sim', sim,".RData")
    if(!file.exists(fitFile )){
      temps_naif = system.time(
        {fitNaif <- SampleCovOnline(data$Z)})
      print(paste0("Erreur Naif = ",norm(fitNaif$Sigma - Sigma0,"F")))
      temps_online  = system.time({fitUsOnline <- StreamingOutlierDetection(data$Z,batch = 1)})
      print(norm(fitUsOnline$Sigma[n,,] - Sigma0,"F"))
      print(paste0("Erreur online = ",norm(fitUsOnline$Sigma[n,,] - Sigma0,"F")))
      #Changer cutoff si d = 100
      if(d == 100){temps_streaming = system.time({fitUSStreaming =StreamingOutlierDetection(data$Z,batch = sqrt(ncol(data$Z)),cutoff = 1.38*qchisq(0.95,df = d))})}
      if(d == 10){temps_streaming = system.time({fitUSStreaming =StreamingOutlierDetection(data$Z,batch = ncol(data$Z))})}
      print(norm(fitUSStreaming$Sigma[n,,] - Sigma0,"F"))
      print(paste0("Erreur streaming = ",norm(fitUSStreaming$Sigma[n,,] - Sigma0,"F")))
      
      setwd(resDir)
      if(d == 10){save(fitNaif, fitUsOnline, fitUSStreaming,temps_naif,temps_online,temps_streaming,file=fitFile)}
      
    }
    if(file.exists(fitFile)){load(fitFile)}
    print(paste0("Erreur Naif = ",norm(fitNaif$Sigma - Sigma0,"F")))
    print(paste0("Erreur online = ",norm(fitUsOnline$Sigma[n,,] - Sigma0,"F")))
    print(paste0("Erreur streaming = ",norm(fitUSStreaming$Sigma[n,,] - Sigma0,"F")))
    erreursSigmalsup1[i,j,1] = norm(fitNaif$Sigma - Sigma0,"F")
    erreursSigmalsup1[i,j,2] = norm(fitUsOnline$Sigma[n,,] - Sigma0,"F")
    erreursSigmalsup1[i,j,3] = norm(fitUSStreaming$Sigma[n,,] - Sigma0,"F")
    
    
    outliers_labelsRecNaive = fitNaif$outliers_labels
    outliers_labelsRecUsOnline = fitUsOnline$outlier_labels
    outliers_labelsRecUsStreaming = fitUSStreaming$outlier_labels
    
    if(nb_outliers != 0){
      fn_naive = (sum(outliers_labelsRecNaive == 0 & data$labelsVrais == 1)/(nb_outliers))*100
      faux_negatifsRatelsup1[i,j,1] = fn_naive
      
      print(paste0("FN naïve ",fn_naive))
      fn_UsOnline = (sum(outliers_labelsRecUsOnline == 0 & data$labelsVrais == 1)/(nb_outliers))*100
      print(paste0("FN Us Online ",fn_UsOnline))
      
      faux_negatifsRatelsup1[i,j,2] = fn_UsOnline
      fn_UsStreaming = sum(outliers_labelsRecUsStreaming == 0 & data$labelsVrais == 1)/(nb_outliers)*100
      print(paste0("FN Us Streaming ",fn_UsStreaming))
      faux_negatifsRatelsup1[i,j,3] = fn_UsStreaming
      
    }
    fp_naive = (sum(outliers_labelsRecNaive == 1 & data$labelsVrais == 0)/(nb_inliers))*100
    
    print(paste0("FP naïve ",fp_naive))
    faux_positifsRatelsup1[i,j,1] = fp_naive
    fp_UsOnline = (sum(outliers_labelsRecUsOnline == 1 & data$labelsVrais == 0)/(nb_inliers))*100
    
    print(paste0("FP us online  ",fp_UsOnline))
    faux_positifsRatelsup1[i,j,2] = fp_UsOnline
    fp_UsStreaming = (sum(outliers_labelsRecUsStreaming == 1 & data$labelsVrais == 0)/(nb_inliers))*100
    faux_positifsRatelsup1[i,j,3] = fp_UsStreaming
    
    print(paste0("FP us streaming  ",fp_UsStreaming))
    
  }
}

erreursSigmaRho1 = array(0,dim = c(length(rList),length(rho1List),3))
faux_negatifsRateRho1 = array(0,dim = c(length(rList),length(rho1List),3))
faux_positifsRateRho1 = array(0,dim = c(length(rList),length(rho1List),3))
k = 0
l = 1
for (i in seq_along(rList)){
  r = rList[i]
  nb_outliers = r/100*n
  nb_inliers = (1 - r/100)*n
  
  for (j in seq_along(rho1List)){
     rho1 = rho1List[j]
     
     dataFile <- paste0('SimData-d', d, '-n', n, '-k', k, '-l', l, '-rho', rho1,'-r',r , '-sim', sim,".RData")
     
     if(!file.exists(dataFile)){
       contParam = ParmsF1(m1, k, l, rho1)
       
       data = genererEchantillon(n,n,mu1 = mu0,mu2 = contParam$mu1,Sigma1 = Sigma0,Sigma2 = contParam$Sigma1,r )
       save(data, file=dataFile)
       print(paste0("n-",n,"d-",d,"k-",k,"l-",l,"r-",r,"-sim",sim," save ok"))
       
     }
     load(dataFile)
    fitFile <- paste0('FitParms-d', d,  '-n', n, '-k', k, '-l', l, '-rho', rho1, '-r',r,'-sim', sim,".RData")
    if(!file.exists(fitFile )){
      temps_naif = system.time(
        {fitNaif <- SampleCovOnline(data$Z)})
      print(paste0("Erreur Naif = ",norm(fitNaif$Sigma - Sigma0,"F")))
      temps_online  = system.time({fitUsOnline <- StreamingOutlierDetection(data$Z,batch = 1)})
      print(norm(fitUsOnline$Sigma[n,,] - Sigma0,"F"))
      print(paste0("Erreur online = ",norm(fitUsOnline$Sigma[n,,] - Sigma0,"F")))
      #Changer cutoff si d = 100
      if(d == 100){temps_streaming = system.time({fitUSStreaming =StreamingOutlierDetection(data$Z,batch = sqrt(ncol(data$Z)),cutoff = 1.38*qchisq(0.95,df = d))})}
      if(d == 10){temps_streaming = system.time({fitUSStreaming =StreamingOutlierDetection(data$Z,batch = ncol(data$Z))})}
      print(norm(fitUSStreaming$Sigma[n,,] - Sigma0,"F"))
      print(paste0("Erreur streaming = ",norm(fitUSStreaming$Sigma[n,,] - Sigma0,"F")))
      
      setwd(resDir)
      if(d == 10){save(fitNaif, fitUsOnline, fitUSStreaming,temps_naif,temps_online,temps_streaming,file=fitFile)}
      
    }
    if(file.exists(fitFile)){load(fitFile)}
    print(paste0("Erreur Naif = ",norm(fitNaif$Sigma - Sigma0,"F")))
    print(paste0("Erreur online = ",norm(fitUsOnline$Sigma[n,,] - Sigma0,"F")))
    print(paste0("Erreur streaming = ",norm(fitUSStreaming$Sigma[n,,] - Sigma0,"F")))
    erreursSigmaRho1[i,j,1] = norm(fitNaif$Sigma - Sigma0,"F")
    erreursSigmaRho1[i,j,2] = norm(fitUsOnline$Sigma[n,,] - Sigma0,"F")
    erreursSigmaRho1[i,j,3] = norm(fitUSStreaming$Sigma[n,,] - Sigma0,"F")
    
    
    outliers_labelsRecNaive = fitNaif$outliers_labels
    outliers_labelsRecUsOnline = fitUsOnline$outlier_labels
    outliers_labelsRecUsStreaming = fitUSStreaming$outlier_labels
    
    if(nb_outliers != 0){
      fn_naive = (sum(outliers_labelsRecNaive == 0 & data$labelsVrais == 1)/(nb_outliers))*100
      faux_negatifsRateRho1[i,j,1] = fn_naive
      
      print(paste0("FN naïve ",fn_naive))
      fn_UsOnline = (sum(outliers_labelsRecUsOnline == 0 & data$labelsVrais == 1)/(nb_outliers))*100
      print(paste0("FN Us Online ",fn_UsOnline))
      
      faux_negatifsRateRho1[i,j,2] = fn_UsOnline
      fn_UsStreaming = sum(outliers_labelsRecUsStreaming == 0 & data$labelsVrais == 1)/(nb_outliers)*100
      print(paste0("FN Us Streaming ",fn_UsStreaming))
      faux_negatifsRateRho1[i,j,3] = fn_UsStreaming
      
    }
    fp_naive = (sum(outliers_labelsRecNaive == 1 & data$labelsVrais == 0)/(nb_inliers))*100
    
    print(paste0("FP naïve ",fp_naive))
    faux_positifsRateRho1[i,j,1] = fp_naive
    fp_UsOnline = (sum(outliers_labelsRecUsOnline == 1 & data$labelsVrais == 0)/(nb_inliers))*100
    
    print(paste0("FP us online  ",fp_UsOnline))
    faux_positifsRateRho1[i,j,2] = fp_UsOnline
    fp_UsStreaming = (sum(outliers_labelsRecUsStreaming == 1 & data$labelsVrais == 0)/(nb_inliers))*100
    faux_positifsRateRho1[i,j,3] = fp_UsStreaming
    
    print(paste0("FP us streaming  ",fp_UsStreaming))
    
  }
}


erreursSigmaRho1Neg = array(0,dim = c(length(rList),length(rho1ListNeg),3))
faux_negatifsRateRho1Neg = array(0,dim = c(length(rList),length(rho1ListNeg),3))
faux_positifsRateRho1Neg = array(0,dim = c(length(rList),length(rho1ListNeg),3))

k = 0
l = 1
for (i in seq_along(rList)){
  r = rList[i]
  nb_outliers = r/100*n
  nb_inliers = (1 - r/100)*n
  
  for (j in seq_along(rho1ListNeg)){
    rho1 = rho1List[j]
    dataFile <- paste0('SimData-d', d, '-n', n, '-k', k, '-l', l, '-rho', rho1,'-r',r , '-sim', sim,".RData")
    
    if(!file.exists(dataFile)){
      contParam = ParmsF1(m1, k, l, rho1)
      
      data = genererEchantillon(n,n,mu1 = mu0,mu2 = contParam$mu1,Sigma1 = Sigma0,Sigma2 = contParam$Sigma1,r )
      save(data, file=dataFile)
      print(paste0("n-",n,"d-",d,"k-",k,"l-",l,"r-",r,"-sim",sim," save ok"))
      
    }
    load(dataFile)
    fitFile <- paste0('FitParms-d', d,  '-n', n, '-k', k, '-l', l, '-rho', rho1, '-r',r,'-sim', sim,".RData")
    setwd(resDir)
    if(!file.exists(fitFile )){
      temps_naif = system.time(
        {fitNaif <- SampleCovOnline(data$Z)})
      print(paste0("Erreur Naif = ",norm(fitNaif$Sigma - Sigma0,"F")))
      temps_online  = system.time({fitUsOnline <- StreamingOutlierDetection(data$Z,batch = 1)})
      print(norm(fitUsOnline$Sigma[n,,] - Sigma0,"F"))
      print(paste0("Erreur online = ",norm(fitUsOnline$Sigma[n,,] - Sigma0,"F")))
      #Changer cutoff si d = 100
      if(d == 100){temps_streaming = system.time({fitUSStreaming =StreamingOutlierDetection(data$Z,batch = sqrt(ncol(data$Z)),cutoff = 1.38*qchisq(0.95,df = d))})}
      if(d == 10){temps_streaming = system.time({fitUSStreaming =StreamingOutlierDetection(data$Z,batch = ncol(data$Z))})}
      print(norm(fitUSStreaming$Sigma[n,,] - Sigma0,"F"))
      print(paste0("Erreur streaming = ",norm(fitUSStreaming$Sigma[n,,] - Sigma0,"F")))
      
      setwd(resDir)
      if(d == 10){save(fitNaif, fitUsOnline, fitUSStreaming,temps_naif,temps_online,temps_streaming,file=fitFile)}
      
    }
    if(file.exists(fitFile)){load(fitFile)}
    print(paste0("Erreur Naif = ",norm(fitNaif$Sigma - Sigma0,"F")))
    print(paste0("Erreur online = ",norm(fitUsOnline$Sigma[n,,] - Sigma0,"F")))
    print(paste0("Erreur streaming = ",norm(fitUSStreaming$Sigma[n,,] - Sigma0,"F")))
    erreursSigmaRho1Neg[i,j,1] = norm(fitNaif$Sigma - Sigma0,"F")
    erreursSigmaRho1Neg[i,j,2] = norm(fitUsOnline$Sigma[n,,] - Sigma0,"F")
    erreursSigmaRho1Neg[i,j,3] = norm(fitUSStreaming$Sigma[n,,] - Sigma0,"F")
    
    
    outliers_labelsRecNaive = fitNaif$outliers_labels
    outliers_labelsRecUsOnline = fitUsOnline$outlier_labels
    outliers_labelsRecUsStreaming = fitUSStreaming$outlier_labels
    
    if(nb_outliers != 0){
      fn_naive = (sum(outliers_labelsRecNaive == 0 & data$labelsVrais == 1)/(nb_outliers))*100
      faux_negatifsRateRho1Neg[i,j,1] = fn_naive
      
      print(paste0("FN naïve ",fn_naive))
      fn_UsOnline = (sum(outliers_labelsRecUsOnline == 0 & data$labelsVrais == 1)/(nb_outliers))*100
      print(paste0("FN Us Online ",fn_UsOnline))
      
      faux_negatifsRateRho1Neg[i,j,2] = fn_UsOnline
      fn_UsStreaming = sum(outliers_labelsRecUsStreaming == 0 & data$labelsVrais == 1)/(nb_outliers)*100
      print(paste0("FN Us Streaming ",fn_UsStreaming))
      faux_negatifsRateRho1Neg[i,j,3] = fn_UsStreaming
      
    }
    fp_naive = (sum(outliers_labelsRecNaive == 1 & data$labelsVrais == 0)/(nb_inliers))*100
    
    print(paste0("FP naïve ",fp_naive))
    faux_positifsRateRho1Neg[i,j,1] = fp_naive
    fp_UsOnline = (sum(outliers_labelsRecUsOnline == 1 & data$labelsVrais == 0)/(nb_inliers))*100
    
    print(paste0("FP us online  ",fp_UsOnline))
    faux_positifsRateRho1Neg[i,j,2] = fp_UsOnline
    fp_UsStreaming = (sum(outliers_labelsRecUsStreaming == 1 & data$labelsVrais == 0)/(nb_inliers))*100
    faux_positifsRateRho1Neg[i,j,3] = fp_UsStreaming
    
    print(paste0("FP us streaming  ",fp_UsStreaming))
    
  }
}



# plot_results <- function(title, ylab, ylim, results, show_legend = TRUE) {
#   # Colors for KL values
#   kl_colors <- c("blue", "orange", "green", "purple")  # KL = 0, 1, 10, 100
#   # Line styles for methods
#   line_types <- c("dotted", "dashed", "solid")  # Sample Cov Online, Online us, Streaming us
#   
#   # Base plot (KL 0, Sample Cov Online)
#   plot(rList, results[,1,1], type = "l", col = kl_colors[1], lwd = 2, lty = line_types[1],
#        xlab = "", ylab = ylab, ylim = ylim, main = title)
#   
#   # Sample Cov Online (dotted)
#   for (kl in 2:4) {
#     lines(rList, results[,kl,1], col = kl_colors[kl], lwd = 2, lty = line_types[1])
#   }
#   # Online us (dashed)
#   for (kl in 1:4) {
#     lines(rList, results[,kl,2], col = kl_colors[kl], lwd = 2, lty = line_types[2])
#   }
#   # Streaming us (solid)
#   for (kl in 1:4) {
#     lines(rList, results[,kl,3], col = kl_colors[kl], lwd = 2, lty = line_types[3])
#   }
#   
#   if (show_legend) {
#     # Legend for KL colors
#     legend("topright",
#            legend = c("KL 0", "KL 1", "KL 10", "KL 100"),
#            col = kl_colors,
#            lty = 1,
#            lwd = 2,
#            cex = 0.8,
#            bty = "n",
#            title = "KL values")
#     
#     # Legend for line types
#     legend("bottomright",
#            legend = c("Sample Cov Online", "Online us", "Streaming us"),
#            col = "black",
#            lty = line_types,
#            lwd = 2,
#            cex = 0.8,
#            bty = "n",
#            title = "Method")
#   }
# }
# 

plot_results <- function(title, ylab, ylim, results, show_legend = TRUE) {
  kl_colors <- c("blue", "orange", "green", "purple")  # KL 0, KL 1, KL 10, KL 100
  line_types <- c("solid", "dashed", "dotted")         # Streaming us, Online us, Sample Cov Online
  
  # Plot initial sans ticks Y
  plot(rList, results[,1,1], type = "l", col = kl_colors[1], lwd = 2, lty = line_types[1],
       xlab = "", ylab = ylab,
       ylim = ylim,
       yaxt = "n",  # pas de ticks par défaut
       main = title)
  
  # Ajout ticks Y à 0, 5, 10, ...
  axis(2, at = seq(0, ylim[2], by = 5), labels = seq(0, ylim[2], by = 5))
  
  # Autres courbes
  for (kl in 2:4) {
    lines(rList, results[,kl,1], col = kl_colors[kl], lwd = 2, lty = line_types[1])
  }
  for (kl in 1:4) {
    lines(rList, results[,kl,2], col = kl_colors[kl], lwd = 2, lty = line_types[2])
    lines(rList, results[,kl,3], col = kl_colors[kl], lwd = 2, lty = line_types[3])
  }
  
  # Légende optionnelle
  if (show_legend) {
    legend("topright",
           legend = c("KL 0", "KL 1", "KL 10", "KL 100"),
           col = kl_colors,
           lwd = 2,
           lty = rep("solid", 4),
           cex = 0.8,
           bty = "n",
           title = "KL values")
    legend("bottomright",
           legend = c("Streaming us", "Online us", "Sample Cov Online"),
           lty = line_types,
           lwd = 2,
           cex = 0.8,
           bty = "n",
           title = "Method")
  }
}
#################################################################Execution of functions#######################################
# 
# for(sim in (1:simNb)){
#   
#  exreslinf1 = exploit_results(linf1,sim)
# exreslsup1 = exploit_results(lsup1,sim)
# exresrho1 = exploit_results(rho1List,sim)
# exresrho1Neg = exploit_results(rho1ListNeg,sim)
# }
# erreursSigmak = exresk$erreursSigma
# erreursSigmalinf1 = exreslinf1$erreursSigma
# erreursSigmalsup1 = exreslsup1$erreursSigma
# erreursSigmaRho1 = exresrho1$erreursSigma
# Layout : 5 plots + 1 ligne entière pour la légende
layout_matrix <- matrix(c(
  1, 2, 3, 4, 5,
  6, 6, 6, 6, 6   # 6 = zone légende
), nrow = 2, byrow = TRUE)

layout(layout_matrix, heights = c(1, 0.3))  # plus petit pour la légende

# Marges standards pour les plots
par(mar = c(4, 4, 2, 1))

# Les 5 sous-graphes sans légende
plot_results("k varying", ylim = c(0, 100), ylab = "Frobenius norm error",
             erreursSigmak, show_legend = FALSE)
plot_results("l <= 1 varying", ylim = c(0, 100), ylab = "",
             erreursSigmalinf1, show_legend = FALSE)
plot_results("l => 1 varying", ylim = c(0, 100), ylab = "",
             erreursSigmalsup1, show_legend = FALSE)
plot_results("rho1 > 0 varying", ylim = c(0, 100), ylab = "",
             erreursSigmaRho1, show_legend = FALSE)
plot_results("rho1 < 0 varying", ylim = c(0, 100), ylab = "",
             erreursSigmaRho1Neg, show_legend = FALSE)

# Zone légende (toute largeur)
par(mar = c(0, 0, 0, 0))
plot.new()
legend("center",
       legend = c("KL 0", "KL 1", "KL 10", "KL 100"),
       col = c("blue", "orange", "green", "purple"),
       lty = 1, lwd = 2, horiz = TRUE,
       title = "KL values", bty = "n", cex = 0.9)

legend("bottom",
       legend = c("Sample Cov Online", "Online us", "Streaming us"),
       col = "black",
       lty = c("dotted", "dashed", "solid"), lwd = 2,
       horiz = TRUE, title = "Method", bty = "n", cex = 0.9)

# # Zone pour la légende
# par(mar = c(0, 0, 0, 0))  # pas de marges
# plot.new()
# # Ajoute le titre global avant la légende
# #mtext("Frobenius norm error for variations of k l and rho1", outer = TRUE, line = -1, cex = 1, font = 1)
# 
# legend("center",
#        legend = c("KL=0 - Sample Cov Online", "KL=1 - Sample Cov Online", "KL=10 - Sample Cov Online", "KL=100 - Sample Cov Online",
#                   "KL=0 - Online us", "KL=1 - Online us", "KL=10 - Online us", "KL=100 - Online us",
#                   "KL=0 - Streaming us", "KL=1 - Streaming us", "KL=10 - Streaming us", "KL=100 - Streaming us"),
#        col = rep(c("blue", "red", "green", "purple"), times = 3),
#        lty = rep(c(1, 2, 3), each = 4),
#        lwd = 2, cex = 1.2, bty = "n", ncol = 3)
# 
# 
# # false_negativesk = exresk$faux_negatifsRate
# # false_negativeslinf1 = exreslinf1$faux_negatifsRate
# # false_negativeslsup1 = exreslsup1$faux_negatifsRate
# # false_negativesrho1 = exresrho1$faux_negatifsRate
# 
# 
# layout(layout_matrix, heights = c(1, 1, 0.4))  # plus petit pour la légende
# 
# # Marges standards pour les plots
# par(mar = c(4, 4, 2, 1))
# Layout : 5 plots + 1 ligne entière pour la légende
layout_matrix <- matrix(c(
  1, 2, 3, 4, 5,
  6, 6, 6, 6, 6   # 6 = zone légende
), nrow = 2, byrow = TRUE)

layout(layout_matrix, heights = c(1, 0.3))  # plus petit pour la légende

# Marges pour les plots
par(mar = c(4, 4, 2, 1))

# Les 5 sous-graphes sans légende
plot_results("k varying", ylim = c(0, 100), ylab = "False negatives",
             faux_negatifsRatek, show_legend = FALSE)
plot_results("l <= 1 varying", ylim = c(0, 100), ylab = "",
             faux_negatifsRatelinf1, show_legend = FALSE)
plot_results("l => 1 varying", ylim = c(0, 100), ylab = "",
             faux_negatifsRatelsup1, show_legend = FALSE)
plot_results("rho1 > 0 varying", ylim = c(0, 100), ylab = "",
             faux_negatifsRateRho1, show_legend = FALSE)
plot_results("rho1 < 0 varying", ylim = c(0, 100), ylab = "",
             faux_negatifsRateRho1Neg, show_legend = FALSE)

# Zone légende
par(mar = c(0, 0, 0, 0))
plot.new()
legend("center",
       legend = c("KL 0", "KL 1", "KL 10", "KL 100"),
       col = c("blue", "orange", "green", "purple"),
       lty = 1, lwd = 2, horiz = TRUE,
       title = "KL values", bty = "n", cex = 0.9)

legend("bottom",
       legend = c("Sample Cov Online", "Online us", "Streaming us"),
       col = "black",
       lty = c("dotted", "dashed", "solid"), lwd = 2,
       horiz = TRUE, title = "Method", bty = "n", cex = 0.9)



##################False positives##############################
###############################################################
layout_matrix <- matrix(c(
  1, 2, 3, 4, 5,
  6, 6, 6, 6, 6   # 6 = zone légende
), nrow = 2, byrow = TRUE)

layout(layout_matrix, heights = c(1, 0.3))  # plus petit pour la légende

# Marges pour les plots
par(mar = c(4, 4, 2, 1))

# Les 5 sous-graphes sans légende
plot_results("k varying", ylim = c(0, 100), ylab = "False positives",
             faux_positifsRatek, show_legend = FALSE)
plot_results("l <= 1 varying", ylim = c(0, 100), ylab = "",
             faux_positifsRatelinf1, show_legend = FALSE)
plot_results("l => 1 varying", ylim = c(0, 100), ylab = "",
             faux_positifsRatelsup1, show_legend = FALSE)
plot_results("rho1 > 0 varying", ylim = c(0, 100), ylab = "",
             faux_positifsRateRho1, show_legend = FALSE)
plot_results("rho1 < 0 varying", ylim = c(0, 100), ylab = "",
             faux_positifsRateRho1Neg, show_legend = FALSE)

# Zone légende
par(mar = c(0, 0, 0, 0))
plot.new()
legend("center",
       legend = c("KL 0", "KL 1", "KL 10", "KL 100"),
       col = c("blue", "orange", "green", "purple"),
       lty = 1, lwd = 2, horiz = TRUE,
       title = "KL values", bty = "n", cex = 0.9)

legend("bottom",
       legend = c("Sample Cov Online", "Online us", "Streaming us"),
       col = "black",
       lty = c("dotted", "dashed", "solid"), lwd = 2,
       horiz = TRUE, title = "Method", bty = "n", cex = 0.9)
